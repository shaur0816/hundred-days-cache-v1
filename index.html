<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ç™¾æ—¥ç¯‰åŸºï½œæ¯æ—¥ç´€éŒ„</title>

  <!-- PWA -->
  <meta name="theme-color" content="#4455aa">
  <link rel="manifest" href="manifest.json">
  <!-- App iconsï¼ˆè«‹æ”¾åœ¨ /icons ä¸‹ï¼‰ -->
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f3f5fb;
      --card: #ffffff;
      --accent: #4455aa;
      --accent-soft: #e0e4ff;
      --text: #222;
      --muted: #666;
      --border: #d5d9e8;
      --danger: #d9534f;
      --radius-lg: 16px;
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,sans-serif;
      background: radial-gradient(circle at top, #eef1ff 0, #f7f8fc 40%, #f3f5fb 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: transparent;
    }

    .app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 10px 14px 8px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 8px);
      background: linear-gradient(180deg, rgba(243,245,251,0.98), rgba(243,245,251,0.9));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(213,217,232,0.8);
    }

    .header-title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      white-space: nowrap;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    .day-panel {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 8px;
      font-size: 12px;
    }

    .day-left {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    select#daySelect {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      min-width: 92px;
      background: #fff;
    }

    .day-buttons button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .day-buttons button:hover {
      border-color: var(--accent);
    }

    .day-info {
      font-size: 11px;
      color: var(--muted);
    }

    .progress-pill {
      margin-left: auto;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f0f3ff;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #c2c8ff;
      position: relative;
      overflow: hidden;
    }

    .progress-dot-inner {
      position: absolute;
      inset: 0;
      transform-origin: left center;
      background: linear-gradient(90deg, #7383ff, #57c4ff);
      transform: scaleX(0);
      border-radius: inherit;
    }

    .app-main {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      padding-bottom: 76px;
    }

    .screen {
      display: none;
      animation: fadeIn .2s ease-out;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .screen-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin: 0 0 6px;
      color: #3a3f68;
    }

    .screen-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 10px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px 14px;
      border: 1px solid rgba(255,255,255,0.8);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card + .card {
      margin-top: 10px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid transparent;
      background: linear-gradient(135deg, rgba(115,131,255,.6), rgba(198,210,255,.4)) border-box;
      -webkit-mask: linear-gradient(#000 0 0) padding-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 2px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: .2em;
    }

    .card-tag {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #f5f6ff;
      color: var(--muted);
      white-space: nowrap;
    }

    .card-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .check-group {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
    }

    label.row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    input[type="number"],
    input[type="text"],
    textarea {
      width: 100%;
      padding: 5px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 32px;
    }

    textarea {
      min-height: 60px;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(68,85,170,0.18);
    }

    .note-label {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ä»Šæ—¥ç¸½è¦½ */
    .summary-list {
      list-style: none;
      margin: 8px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(213,217,232,0.9);
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      font-size: 13px;
    }

    .summary-dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid #d0d4ec;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .summary-dot-inner {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 0, #fff 0, #73d1ff 30%, #7383ff 100%);
      opacity: 0;
      transition: opacity .15s;
    }

    .summary-item.done .summary-dot-inner {
      opacity: 1;
    }

    .summary-item-label {
      flex: 1;
    }

    .summary-item-label strong {
      font-weight: 600;
      margin-right: 4px;
    }

    .summary-item-status {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    .summary-note {
      margin-top: 10px;
    }

    /* åº•éƒ¨å°è¦½åˆ— */
    .app-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      background: rgba(255,255,255,0.98);
      border-top: 1px solid rgba(213,217,232,0.95);
      box-shadow: 0 -4px 18px rgba(0,0,0,0.08);
    }

    .nav-inner {
      max-width: 820px;
      margin: 0 auto;
      display: flex;
      align-items: stretch;
      justify-content: space-between;
      padding: 4px 4px;
      gap: 2px;
    }

    .nav-btn {
      flex: 1;
      border: none;
      background: transparent;
      padding: 3px 2px 2px;
      border-radius: 999px;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      position: relative;
    }

    .nav-btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #f2f3ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    .nav-btn span.label {
      line-height: 1.1;
    }

    .nav-btn.active .nav-btn-icon {
      background: linear-gradient(135deg,#7383ff,#57c4ff);
      color: #fff;
      box-shadow: 0 4px 12px rgba(87,196,255,0.5);
    }

    .nav-btn.active {
      color: #2f3466;
      font-weight: 600;
    }

    .nav-btn-indicator {
      position: absolute;
      bottom: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg,#7383ff,#57c4ff);
      opacity: 0;
      transition: opacity .15s;
    }

    .nav-btn.active .nav-btn-indicator {
      opacity: 1;
    }

    /* åŒ¯å‡º / è¨­å®š */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }

    .btn.primary {
      background: linear-gradient(135deg,#7383ff,#57c4ff);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(87,196,255,0.5);
    }

    .btn.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: #fff4f4;
    }

    .btn + .btn {
      margin-left: 6px;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hint-text {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    footer {
      text-align: center;
      font-size: 10px;
      color: var(--muted);
      margin-top: 10px;
      margin-bottom: 6px;
    }

    /* åœ–è¡¨é  */
    .chart-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 10px 12px;
      border: 1px solid rgba(255,255,255,0.8);
    }

    .chart-card + .chart-card {
      margin-top: 10px;
    }

    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 4px;
      color: #3a3f68;
    }

    .chart-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin: 0 0 6px;
    }

    .chart-wrapper {
      width: 100%;
      max-height: 260px;
    }

    .chart-wrapper canvas {
      width: 100%;
      height: 220px;
    }

    .chart-meta {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
    }

    .chart-meta span strong {
      color: #4455aa;
    }

    @media (min-width: 768px) {
      .app-main {
        max-width: 820px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="app-header">
    <div class="header-title-row">
      <h1>
        ç™¾æ—¥ç¯‰åŸº
        <span class="badge">å…§æ˜æˆå°± 100 Days</span>
      </h1>
      <div class="progress-pill">
        <div class="progress-dot">
          <div class="progress-dot-inner" id="progressDotInner"></div>
        </div>
        <span id="progressText">0 / 6</span>
      </div>
    </div>
    <p class="subtitle">
      å¿™ç¢Œä¸­ä¹Ÿçµ¦è‡ªå·±ä¸€é»é»ã€Œå‘å…§ã€çš„æ™‚é–“ã€‚æ¯å¤©è¨˜éŒ„å…­å¤§é …ï¼šå‡ºé›¢å¿ƒã€è©æå¿ƒã€èº«ã€èªã€æ„ã€ä¸‹åº§ã€‚
    </p>
    <div class="day-panel">
      <div class="day-left">
        <span style="font-size:11px;">å¤©æ•¸ï¼š</span>
        <select id="daySelect"></select>
        <div class="day-buttons">
          <button type="button" id="prevDayBtn">â† å‰ä¸€å¤©</button>
          <button type="button" id="nextDayBtn">å¾Œä¸€å¤© â†’</button>
        </div>
      </div>
      <div class="day-info" id="dayInfo"></div>
    </div>
  </header>

  <!-- Main content -->
  <main class="app-main">
    <!-- ä»Šæ—¥ç¸½è¦½ -->
    <section class="screen screen-home active" data-screen="home">
      <h2 class="screen-title">ä»Šæ—¥ç¸½è¦½</h2>
      <p class="screen-subtitle">
        å…­å¤§é …å®Œæˆåº¦ä»¥ã€Œé …ç›®ã€è¨ˆç®—ï¼šä»»ä¸€å­é …æœ‰æ‰“å‹¾ â†’ è©²å¤§é …å®Œæˆã€‚é”æˆ 6 / 6 å°±æ˜¯ä»Šæ—¥æ»¿åˆ†ã€‚
      </p>

      <ul class="summary-list">
        <li class="summary-item" data-summary="chuli">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>å‡ºé›¢å¿ƒ</strong><span>æ€ç¶­ç„¡å¸¸ï¼Œè¨˜å¾—ç”Ÿå‘½æœ‰é™ã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
        <li class="summary-item" data-summary="putixin">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>è©æå¿ƒ</strong><span>é¡˜ä¸€åˆ‡çœ¾ç”Ÿé›¢è‹¦å¾—æ¨‚ã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
        <li class="summary-item" data-summary="shen">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>èº«</strong><span>é‹å‹•ã€å¥½å¥½ç¡ã€å¥½å¥½åƒã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
        <li class="summary-item" data-summary="yu">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>èª</strong><span>å°‘é€ å£æ¥­ï¼Œå¤šèªªå¥½è©±ã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
        <li class="summary-item" data-summary="yi">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>æ„</strong><span>å®šä¸­æœ‰æ…§ï¼Œè¦ºå¯Ÿå¿µé ­ã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
        <li class="summary-item" data-summary="xiazuo">
          <div class="summary-dot"><div class="summary-dot-inner"></div></div>
          <div class="summary-item-label">
            <strong>ä¸‹åº§</strong><span>ç”Ÿæ´»ä¸­ä¹Ÿä¿æŒæ¸…æ˜ã€‚</span>
          </div>
          <div class="summary-item-status">æœªå®Œæˆ</div>
        </li>
      </ul>

      <div class="summary-note">
        <div class="note-label">ä»Šæ—¥æ•´é«”å°çµï¼ˆé¸å¡«ï¼‰ï¼š</div>
        <textarea data-field="summary_note" placeholder="æƒ³çµ¦è‡ªå·±çš„ä»Šæ—¥ä¸€å¥è©±ã€äº®é»æˆ–éœ€è¦èª¿æ•´çš„åœ°æ–¹ã€‚"></textarea>
      </div>

      <p class="hint-text">
        å°æé†’ï¼šä¸‹æ–¹ Tab å¯åˆ‡æ›åˆ°ã€Œå‡ºé›¢/è©æã€ã€ã€Œèº«ã€ã€ã€Œèªï¼†æ„ã€ã€ã€Œä¸‹åº§/åŒ¯å‡ºã€ã€ã€Œåœ–è¡¨ã€ã€‚æ‰€æœ‰ç´€éŒ„éƒ½æœƒè‡ªå‹•å„²å­˜åˆ°æœ¬æ©Ÿç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
      </p>
    </section>

    <!-- å‡ºé›¢å¿ƒ + è©æå¿ƒ -->
    <section class="screen" data-screen="chuli">
      <h2 class="screen-title">å‡ºé›¢ / è©æ</h2>
      <p class="screen-subtitle">
        ä»¥å…­å€‹ç”Ÿæ´»ç¯€é»æé†’è‡ªå·±ï¼šèµ·åºŠã€ä¸Šåº§å‰ã€ä¸‰é¤å‰ã€ç¡å‰ã€‚ä¹Ÿå¯ä»¥ä¾ç…§è‡ªå·±çš„ä½œæ¯èª¿æ•´ã€‚
      </p>

      <!-- å‡ºé›¢å¿ƒ -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">å‡ºé›¢å¿ƒ</div>
          <div class="card-tag">æ€ç¶­ç„¡å¸¸å…­æ¬¡</div>
        </div>
        <p class="card-desc">
          æ¯æ—¥æ€ç¶­ã€Œä¸€åˆ‡ç„¡å¸¸ï¼Œç”Ÿå‘½æœ‰é™ã€ï¼Œè‡³å°‘å…­æ¬¡ã€‚å¯ä¾èµ·åºŠã€ä¸Šåº§å‰ã€ä¸‰é¤å‰ã€ç¡å‰ç­‰ç¯€é»æé†’è‡ªå·±ã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="chuli_morningWake_chk">
            <span>èµ·åºŠå¾Œ</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="chuli_beforeMedit_chk">
            <span>ä¸Šåº§å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="chuli_beforeBreakfast_chk">
            <span>æ—©é¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="chuli_beforeLunch_chk">
            <span>åˆé¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="chuli_beforeDinner_chk">
            <span>æ™šé¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="chuli_beforeSleep_chk">
            <span>ç¡å‰</span>
          </label>
        </div>
        <div class="note-label">ä»Šå¤©åœ¨å‡ºé›¢å¿ƒä¸Šçš„é«”æœƒï¼ˆå¯ç•¥ï¼‰ï¼š</div>
        <textarea data-field="chuli_note" placeholder="ä¾‹å¦‚ï¼šæ›´æ¸…æ¥šæ„Ÿå—åˆ°æ™‚é–“ä¸ç­‰äººï¼Œæ‰€ä»¥å°‘æ»‘äº†ä¸€æ¬¡æ‰‹æ©Ÿã€‚"></textarea>
      </article>

      <!-- è©æå¿ƒ -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">è©æå¿ƒ</div>
          <div class="card-tag">å¿µå…­é“çˆ¶æ¯</div>
        </div>
        <p class="card-desc">
          æ¯æ—¥æ€ç¶­ä¸€åˆ‡çœ¾ç”Ÿå¦‚çˆ¶æ¯ï¼Œä»åœ¨è¼ªè¿´å—è‹¦ï¼Œé¡˜ä»¥ä¿®è¡Œåˆ©ç›Šä»–å€‘ï¼ŒåŒæ¨£è‡³å°‘å…­æ¬¡ã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="putixin_morningWake_chk">
            <span>èµ·åºŠå¾Œ</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="putixin_beforeMedit_chk">
            <span>ä¸Šåº§å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="putixin_beforeBreakfast_chk">
            <span>æ—©é¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="putixin_beforeLunch_chk">
            <span>åˆé¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="putixin_beforeDinner_chk">
            <span>æ™šé¤å‰</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="putixin_beforeSleep_chk">
            <span>ç¡å‰</span>
          </label>
        </div>
        <div class="note-label">ä»Šå¤©è©æå¿ƒçš„ç™¼é¡˜ï¼æ„Ÿå‹•ï¼š</div>
        <textarea data-field="putixin_note" placeholder="ä¾‹å¦‚ï¼šæƒ³åˆ°åŒäº‹ä¹Ÿåœ¨å£“åŠ›ä¸­ï¼Œå¸Œæœ›ä¸€èµ·é›¢è‹¦å¾—æ¨‚ã€‚"></textarea>
      </article>
    </section>

    <!-- èº« -->
    <section class="screen" data-screen="shen">
      <h2 class="screen-title">èº«</h2>
      <p class="screen-subtitle">
        èº«é«”æ˜¯ä¿®è¡Œçš„å·¥å…·ã€‚å¯åƒè€ƒï¼šæ…¢è·‘äºŒååˆ†é˜ã€é‡è¨“ã€æ¯æ—¥ä¸€åƒæ­¥ã€å°‘æ²¹ç‚¸ã€åé»å‰ç¡ã€æ›¬å¤ªé™½ååˆ†é˜ç­‰ã€‚
      </p>

      <article class="card">
        <div class="card-header">
          <div class="card-title">èº«é«”ç…§é¡§</div>
          <div class="card-tag">é‹å‹•ï¼é£²é£Ÿï¼ä½œæ¯ï¼æ›¬å¤ªé™½</div>
        </div>
        <p class="card-desc">
          ä»Šå¤©æœ‰åšåˆ°å“ªäº›ï¼Ÿåªè¦ä»»ä¸€é …æ‰“å‹¾ï¼Œå°±ç®—ã€Œèº«ã€é€™ä¸€å¤§é …å®Œæˆã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="shen_run20_chk">
            <span>é‹å‹• EX1ï¼šæ—©/æ™šæ…¢è·‘ â‰¥ 20 åˆ†é˜</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="shen_training_chk">
            <span>é‹å‹• EX2ï¼šé‡è¨“ / å…¶ä»–é‹å‹•</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="shen_steps_chk">
            <span>é‹å‹• EX3ï¼šæ­¥è¡Œ â‰¥ 1000 æ­¥</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="shen_food_chk">
            <span>é£²é£Ÿï¼šå°‘æ²¹ç‚¸ã€å°‘å®µå¤œ</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="shen_sleepEarly_chk">
            <span>ä½œæ¯ï¼šæ™šä¸Š 10 é»å‰å…¥ç¡</span>
          </label>
          <label class="row">
            <input type="checkbox" data-field="shen_sun_chk">
            <span>æ›¬å¤ªé™½ â‰¥ 10 åˆ†é˜ï¼ˆ10â€“15 é»ï¼‰</span>
          </label>
        </div>
        <div class="note-label">ä»Šå¤©èº«é«”ç…§é¡§çš„ç´€éŒ„ï¼ˆå¯å¡«å¯¦éš›é‹å‹•å…§å®¹ï¼‰ï¼š</div>
        <textarea data-field="shen_note" placeholder="ä¾‹å¦‚ï¼šæ™šä¸Šæ•£æ­¥ 30 åˆ†é˜ï¼Œç²¾ç¥è®Šå¥½å¾ˆå¤šã€‚"></textarea>
      </article>
    </section>

    <!-- èª + æ„ -->
    <section class="screen" data-screen="yu">
      <h2 class="screen-title">èª &amp; æ„</h2>
      <p class="screen-subtitle">
        èªï¼šæ¸…æ·¨èªè¨€ã€ä¸é€ å£æ¥­ã€‚æ„ï¼šå®šèˆ‡æ…§ï¼Œé€éç¦ªä¿®èˆ‡å­¸ç¿’ï¼Œæ…¢æ…¢çœ‹æ¸…è‡ªå·±çš„å¿ƒã€‚
      </p>

      <!-- èª -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">èª</div>
          <div class="card-tag">äº”å¤§æ·¨åŒ–æ³•ï¼å®‰é‚£èˆ¬é‚£</div>
        </div>
        <p class="card-desc">
          ç·´ç¿’æ¸…æ·¨èªè¨€ï¼Œä¸é€ å£æ¥­ï¼›æ­é…å¿µèª¦ã€æŒå’’æˆ–å®‰é‚£èˆ¬é‚£å‘¼å¸ç­‰æ–¹æ³•ï¼Œæ·¨åŒ–èº«å¿ƒã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="yu_purify_chk">
            <span>ä»Šæ—¥åˆ»æ„ç·´ç¿’ã€Œäº”å¤§æ·¨åŒ–æ³•ã€</span>
          </label>
          <label class="row">
            <span>äº”å¤§æ·¨åŒ–æ³•å…±ç·´å¹¾æ¬¡ï¼Ÿ</span>
          </label>
          <input type="number" min="0" step="1" data-field="yu_purify_times" placeholder="ä¾‹å¦‚ï¼š3">
          <label class="row" style="margin-top:4px;">
            <input type="checkbox" data-field="yu_anapana_chk">
            <span>å®‰é‚£èˆ¬é‚£ï¼ˆå‡ºå…¥æ¯å¿µï¼‰ç·´ç¿’</span>
          </label>
          <label class="row">
            <span>å®‰é‚£èˆ¬é‚£å…±ç·´å¹¾åˆ†é˜ï¼Ÿ</span>
          </label>
          <input type="number" min="0" step="1" data-field="yu_anapana_minutes" placeholder="ä¾‹å¦‚ï¼š15">
        </div>
        <div class="note-label">ä»Šå¤©èªªè©±ä¸Šæœ‰ç•™æ„åˆ°ä»€éº¼ï¼Ÿ</div>
        <textarea data-field="yu_note" placeholder="ä¾‹å¦‚ï¼šå¿ä½æ²’æœ‰æŠ±æ€¨ï¼ŒæŠŠè©±æ›æˆå»ºè­°ã€‚"></textarea>
      </article>

      <!-- æ„ -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">æ„</div>
          <div class="card-tag">å®šï¼æ…§</div>
        </div>
        <p class="card-desc">
          ã€Œå®šã€ï¼šä¸Šåº§ç¦ªä¿®ï¼è§€æ¯ï¼›ã€Œæ…§ã€ï¼šè¤‡ç¿’æ³•ç¾©ã€æ•´ç†ç­†è¨˜ã€çœ‹åˆ°æ–°çš„è§€é»æˆ–è½‰å¿µã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="yi_medit_chk">
            <span>ä»Šå¤©æœ‰æ­£å¼ä¸Šåº§ç¦ªä¿®</span>
          </label>
          <label class="row">
            <span>ä¸Šåº§å…±å¹¾å°æ™‚ï¼Ÿ</span>
          </label>
          <input type="number" min="0" step="0.25" data-field="yi_medit_hours" placeholder="ä¾‹å¦‚ï¼š0.5ï¼ˆ30 åˆ†é˜ï¼‰">
          <label class="row" style="margin-top:4px;">
            <input type="checkbox" data-field="yi_wisdom_chk">
            <span>æ…§ï¼šè¤‡ç¿’çŸ¥è¦‹ / è®€æ›¸ / ä¸Šèª²</span>
          </label>
        </div>
        <div class="note-label">ä»Šå¤©æœ‰ä»€éº¼æ–°çš„ç™¼ç¾æˆ–è½‰å¿µï¼Ÿ</div>
        <textarea data-field="yi_note" placeholder="ä¾‹å¦‚ï¼šå¯Ÿè¦ºåˆ°ç…©èºå…¶å¯¦ä¾†è‡ªæ€•è¢«å¦å®šã€‚"></textarea>
      </article>
    </section>

    <!-- ä¸‹åº§ + åŒ¯å‡º -->
    <section class="screen" data-screen="more">
      <h2 class="screen-title">ä¸‹åº§ &amp; åŒ¯å‡º</h2>
      <p class="screen-subtitle">
        ä¸‹åº§ä¸­ä¹Ÿç¶­æŒè¦ºçŸ¥ï¼šä½¿ç”¨æ‰‹æ©Ÿã€å·¥ä½œã€èˆ‡äººäº’å‹•ï¼Œéƒ½ç›¡é‡å¸¶è‘—æ¸…æ˜ã€‚é€™è£¡ä¹Ÿå¯ä»¥åŒ¯å‡ºå…¨éƒ¨ç´€éŒ„åšå‚™ä»½ã€‚
      </p>

      <!-- ä¸‹åº§ -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">ä¸‹åº§</div>
          <div class="card-tag">ç”Ÿæ´»å¯¦ä¿®</div>
        </div>
        <p class="card-desc">
          ä¸‹åº§æ™‚ç¶­æŒæ¸…æ˜ã€‚ç¯„ä¾‹ï¼šæ¯æ—¥æ‰‹æ©Ÿæ‰“ç™¼æ™‚é–“ä½æ–¼ä¸€å°æ™‚ã€å·¥ä½œä¸­ä¿æŒè¦ºçŸ¥ã€ä¸è¢«æƒ…ç·’ç‰½è‘—èµ°ã€‚
        </p>
        <div class="check-group">
          <label class="row">
            <input type="checkbox" data-field="xiazuo_phone_chk">
            <span>ä»Šå¤©æ»‘æ‰‹æ©Ÿæ‰“ç™¼æ™‚é–“ä½æ–¼ 1 å°æ™‚</span>
          </label>
          <label class="row">
            <span>ä¼°è¨ˆå¯¦éš›æ»‘æ‰‹æ©Ÿæ‰“ç™¼çš„æ™‚é–“ï¼ˆåˆ†é˜ï¼‰ï¼š</span>
          </label>
          <input type="number" min="0" step="5" data-field="xiazuo_phone_minutes" placeholder="ä¾‹å¦‚ï¼š35">
          <label class="row" style="margin-top:4px;">
            <input type="checkbox" data-field="xiazuo_mindfulWork_chk">
            <span>å·¥ä½œï¼å®¶å‹™æ™‚æœ‰åˆ»æ„ä¿æŒè¦ºçŸ¥</span>
          </label>
        </div>
        <div class="note-label">ä¸‹åº§ç”Ÿæ´»ä¸­çš„è§€å¯Ÿï¼š</div>
        <textarea data-field="xiazuo_note" placeholder="ä¾‹å¦‚ï¼šæ’éšŠæ™‚æ²’æœ‰æ»‘æ‰‹æ©Ÿï¼Œæ”¹è§€å¯Ÿå‘¼å¸ã€‚"></textarea>
      </article>

      <!-- åŒ¯å‡º / é‡ç½® -->
      <article class="card" style="margin-top:12px;">
        <div class="card-header">
          <div class="card-title">åŒ¯å‡ºèˆ‡å‚™ä»½</div>
        </div>
        <p class="card-desc">
          åŒ¯å‡ºçš„æ˜¯ã€Œå…¨éƒ¨ 100 å¤©ã€çš„ç´€éŒ„ï¼ˆå«å°šæœªå¡«å¯«çš„å¤©æ•¸æœƒç•™ç©ºï¼‰ã€‚ä½ å¯ä»¥ç”¨ä¾†å‚™ä»½ã€åˆ†ææˆ–å°å‡ºç´™æœ¬ã€‚
        </p>
        <div class="btn-row">
          <button type="button" class="btn primary" id="exportJsonBtn">ä¸‹è¼‰ JSON å‚™ä»½</button>
          <button type="button" class="btn" id="exportCsvBtn">ä¸‹è¼‰ CSVï¼ˆExcelï¼‰</button>
        </div>
        <p class="hint-text">
          JSON é©åˆä½œç‚ºå®Œæ•´å‚™ä»½ï¼›CSV å¯ä»¥ç”¨ Excel æˆ– Google è©¦ç®—è¡¨æ‰“é–‹ï¼Œçœ‹é•·æœŸçš„è¶¨å‹¢ã€‚
        </p>
        <hr style="margin:10px 0;border:none;border-top:1px dashed #e0e2f0;">
        <div class="btn-row">
          <button type="button" class="btn" id="resetDayBtn">æ¸…é™¤ã€Œæœ¬æ—¥ã€ç´€éŒ„</button>
          <button type="button" class="btn danger" id="resetAllBtn">æ¸…é™¤å…¨éƒ¨ 100 å¤©ç´€éŒ„</button>
        </div>
        <p class="hint-text">
          âš ï¸ æ¸…é™¤å¾Œè³‡æ–™ç„¡æ³•å¾©åŸï¼Œè«‹å…ˆåšå¥½åŒ¯å‡ºå‚™ä»½å†æ“ä½œã€‚
        </p>
      </article>

      <footer>
        ç™¾æ—¥ç¯‰åŸºåªæ˜¯æ¡†æ¶ï¼Œæœ€é‡è¦çš„æ˜¯ï¼šå³ä½¿å¾ˆå¿™ï¼Œæ¯å¤©ä¹Ÿé¡˜æ„å¾€å…§åœ¨ç©©å®šèˆ‡æ¸…æ˜é è¿‘ä¸€é»é»ã€‚ğŸŒ±
      </footer>
    </section>

    <!-- åœ–è¡¨é  -->
    <section class="screen" data-screen="charts">
      <h2 class="screen-title">åœ–è¡¨</h2>
      <p class="screen-subtitle">
        ç”¨è¦–è¦ºåŒ–ä¾†çœ‹è‡ªå·±çš„ç™¾æ—¥æ­·ç¨‹ï¼šæ¯å¤©å®Œæˆå¹¾é …ï¼Ÿå…­å¤§é …è£¡ï¼Œå“ªä¸€é …æ˜¯ä½ çš„å¼·é …èˆ‡éœ€è¦åŠ å¼·çš„åœ°æ–¹ï¼Ÿ
      </p>

      <div class="chart-card">
        <h3 class="chart-title">æ¯æ—¥å®Œæˆåº¦ï¼ˆ0â€“6 é …ï¼‰</h3>
        <p class="chart-subtitle">æ©«è»¸æ˜¯ Day1â€“Day100ï¼Œç¸±è»¸æ˜¯ç•¶å¤©å®Œæˆçš„å¤§é …æ•¸é‡ï¼ˆæœ€å¤š 6ï¼‰ã€‚</p>
        <div class="chart-wrapper">
          <canvas id="dailyChart"></canvas>
        </div>
        <div class="chart-meta" id="dailyChartMeta"></div>
      </div>

      <div class="chart-card">
        <h3 class="chart-title">å…­å¤§é …å®Œæˆç‡</h3>
        <p class="chart-subtitle">çµ±è¨ˆç›®å‰å·²å¡«å¯«ç´€éŒ„çš„å¤©æ•¸ä¸­ï¼Œå„é …ç›®å®Œæˆçš„æ¯”ä¾‹ã€‚</p>
        <div class="chart-wrapper">
          <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-meta" id="categoryChartMeta"></div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="app-nav">
    <div class="nav-inner">
      <button class="nav-btn active" data-target="home">
        <div class="nav-btn-icon">ğŸ“…</div>
        <span class="label">ä»Šæ—¥</span>
        <div class="nav-btn-indicator"></div>
      </button>
      <button class="nav-btn" data-target="chuli">
        <div class="nav-btn-icon">ğŸ§­</div>
        <span class="label">å‡ºé›¢/è©æ</span>
        <div class="nav-btn-indicator"></div>
      </button>
      <button class="nav-btn" data-target="shen">
        <div class="nav-btn-icon">ğŸ§˜</div>
        <span class="label">èº«</span>
        <div class="nav-btn-indicator"></div>
      </button>
      <button class="nav-btn" data-target="yu">
        <div class="nav-btn-icon">ğŸ—£ï¸</div>
        <span class="label">èªï¼†æ„</span>
        <div class="nav-btn-indicator"></div>
      </button>
      <button class="nav-btn" data-target="more">
        <div class="nav-btn-icon">ğŸ¡</div>
        <span class="label">ä¸‹åº§/åŒ¯å‡º</span>
        <div class="nav-btn-indicator"></div>
      </button>
      <button class="nav-btn" data-target="charts">
        <div class="nav-btn-icon">ğŸ“ˆ</div>
        <span class="label">åœ–è¡¨</span>
        <div class="nav-btn-indicator"></div>
      </button>
    </div>
  </nav>
</div>

<script>
(function () {
  const TOTAL_DAYS = 100;
  const STORAGE_KEY = "hundredDaysPlan_v2";
  const LAST_DAY_KEY = "hundredDaysPlan_lastDay_v2";

  const daySelect = document.getElementById("daySelect");
  const prevBtn = document.getElementById("prevDayBtn");
  const nextBtn = document.getElementById("nextDayBtn");
  const dayInfo = document.getElementById("dayInfo");
  const exportJsonBtn = document.getElementById("exportJsonBtn");
  const exportCsvBtn = document.getElementById("exportCsvBtn");
  const resetDayBtn = document.getElementById("resetDayBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");
  const progressText = document.getElementById("progressText");
  const progressDotInner = document.getElementById("progressDotInner");

  const screens = Array.from(document.querySelectorAll(".screen"));
  const navButtons = Array.from(document.querySelectorAll(".nav-btn"));
  const fieldElements = Array.from(document.querySelectorAll("[data-field]"));

  const dailyChartCanvas = document.getElementById("dailyChart");
  const categoryChartCanvas = document.getElementById("categoryChart");
  const dailyChartMeta = document.getElementById("dailyChartMeta");
  const categoryChartMeta = document.getElementById("categoryChartMeta");

  let dailyChart = null;
  let categoryChart = null;

  const CATEGORY_CONFIG = [
    { key: "chuli", label: "å‡ºé›¢å¿ƒ" },
    { key: "putixin", label: "è©æå¿ƒ" },
    { key: "shen", label: "èº«" },
    { key: "yu", label: "èª" },
    { key: "yi", label: "æ„" },
    { key: "xiazuo", label: "ä¸‹åº§" },
  ];

  // åˆå§‹åŒ– Day é¸å–®
  for (let i = 1; i <= TOTAL_DAYS; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Day ${i}`;
    daySelect.appendChild(opt);
  }

  function loadAllData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      console.warn("è®€å–è³‡æ–™å¤±æ•—ï¼Œå°‡é‡æ–°åˆå§‹åŒ–ã€‚", e);
      return {};
    }
  }

  function saveAllData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function getCurrentDay() {
    return parseInt(daySelect.value, 10);
  }

  function setCurrentDay(day) {
    if (day < 1) day = 1;
    if (day > TOTAL_DAYS) day = TOTAL_DAYS;
    daySelect.value = String(day);
    localStorage.setItem(LAST_DAY_KEY, String(day));
    renderDayInfo();
    loadDayToForm(day);
    updateProgressAndSummary();
    updateCharts();
  }

  function renderDayInfo() {
    const day = getCurrentDay();
    dayInfo.textContent = `ç¬¬ ${day} å¤©ï¼å…± ${TOTAL_DAYS} å¤©`;
  }

  function loadDayToForm(day) {
    const data = loadAllData();
    const dayKey = "day_" + day;
    const dayData = data[dayKey] || {};

    fieldElements.forEach((el) => {
      const key = el.dataset.field;
      const value = dayData[key];

      if (el.type === "checkbox") {
        el.checked = Boolean(value);
      } else if (el.tagName === "TEXTAREA" || el.type === "text" || el.type === "number") {
        el.value = value != null ? value : "";
      }
    });
  }

  function collectFormToDayData() {
    const result = {};
    fieldElements.forEach((el) => {
      const key = el.dataset.field;
      if (el.type === "checkbox") {
        result[key] = el.checked;
      } else {
        result[key] = el.value;
      }
    });
    return result;
  }

  function saveCurrentDay() {
    const day = getCurrentDay();
    const data = loadAllData();
    const dayKey = "day_" + day;
    data[dayKey] = collectFormToDayData();
    saveAllData(data);
    updateProgressAndSummary();
    updateCharts();
  }

  function isCategoryDoneFromDOM(prefix) {
    const checkboxes = document.querySelectorAll(
      `input[type="checkbox"][data-field^="${prefix}_"]`
    );
    for (const cb of checkboxes) {
      if (cb.checked) return true;
    }
    return false;
  }

  function updateProgressAndSummary() {
    const summaryItems = CATEGORY_CONFIG.map((cfg) => {
      return {
        key: cfg.key,
        label: cfg.label,
        done: isCategoryDoneFromDOM(cfg.key),
      };
    });

    const completedCount = summaryItems.filter((s) => s.done).length;
    const percent = Math.round((completedCount / CATEGORY_CONFIG.length) * 100);

    // æ›´æ–°é ‚éƒ¨å®Œæˆåº¦
    progressText.textContent = `${completedCount} / ${CATEGORY_CONFIG.length}ï¼ˆ${percent}%ï¼‰`;
    progressDotInner.style.transform = `scaleX(${completedCount / CATEGORY_CONFIG.length})`;

    // æ›´æ–°ä»Šæ—¥ç¸½è¦½åˆ—è¡¨
    summaryItems.forEach((item) => {
      const li = document.querySelector(`.summary-item[data-summary="${item.key}"]`);
      if (!li) return;
      li.classList.toggle("done", item.done);
      const statusEl = li.querySelector(".summary-item-status");
      if (statusEl) {
        statusEl.textContent = item.done ? "å·²å®Œæˆ" : "æœªå®Œæˆ";
      }
    });
  }

  function resetCurrentDay() {
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ—¥æ‰€æœ‰ç´€éŒ„å—ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
    const day = getCurrentDay();
    const data = loadAllData();
    const dayKey = "day_" + day;
    delete data[dayKey];
    saveAllData(data);
    loadDayToForm(day);
    updateProgressAndSummary();
    updateCharts();
  }

  function resetAllDays() {
    if (!confirm("âš ï¸ é€™æœƒåˆªé™¤å…¨éƒ¨ 100 å¤©çš„ç´€éŒ„ã€‚\nå»ºè­°å…ˆåŒ¯å‡º JSON æˆ– CSV å‚™ä»½ã€‚\n\nä»è¦ç¹¼çºŒå—ï¼Ÿ")) {
      return;
    }
    localStorage.removeItem(STORAGE_KEY);
    const day = getCurrentDay();
    loadDayToForm(day);
    updateProgressAndSummary();
    updateCharts();
  }

  function exportJSON() {
    const data = loadAllData();
    const payload = {
      version: 3,
      totalDays: TOTAL_DAYS,
      exportedAt: new Date().toISOString(),
      data,
    };
    const jsonStr = JSON.stringify(payload, null, 2);
    downloadFile(jsonStr, "application/json", `hundred-days-backup-${getDateStamp()}.json`);
  }

  function isCategoryDoneFromDayData(dayData, prefix) {
    if (!dayData) return false;
    return Object.keys(dayData).some((key) => {
      return key.startsWith(prefix + "_") && key.endsWith("_chk") && !!dayData[key];
    });
  }

  function exportCSV() {
    const data = loadAllData();

    // å–å¾—æ‰€æœ‰æ¬„ä½åç¨±
    const fieldKeys = Array.from(
      new Set(fieldElements.map((el) => el.dataset.field))
    );

    const header = [
      "day",
      "done_chuli",
      "done_putixin",
      "done_shen",
      "done_yu",
      "done_yi",
      "done_xiazuo",
      "completed_count",
      "completed_percent",
      ...fieldKeys
    ];

    const rows = [];
    rows.push(header.join(","));

    for (let day = 1; day <= TOTAL_DAYS; day++) {
      const dayKey = "day_" + day;
      const dayData = data[dayKey] || {};

      const doneFlags = CATEGORY_CONFIG.map((cfg) =>
        isCategoryDoneFromDayData(dayData, cfg.key)
      );
      const completedCount = doneFlags.filter(Boolean).length;
      const completedPercent = Math.round(
        (completedCount / CATEGORY_CONFIG.length) * 100
      );

      const row = [
        day,
        doneFlags[0] ? 1 : 0,
        doneFlags[1] ? 1 : 0,
        doneFlags[2] ? 1 : 0,
        doneFlags[3] ? 1 : 0,
        doneFlags[4] ? 1 : 0,
        doneFlags[5] ? 1 : 0,
        completedCount,
        completedPercent,
        ...fieldKeys.map((key) => {
          const value = dayData[key];
          if (typeof value === "boolean") {
            return value ? "1" : "";
          }
          return value == null ? "" : String(value);
        })
      ];

      rows.push(row.map(toCsvValue).join(","));
    }

    const csvStr = rows.join("\r\n");
    downloadFile(csvStr, "text/csv", `hundred-days-records-${getDateStamp()}.csv`);
  }

  function toCsvValue(value) {
    const s = String(value ?? "");
    if (/[",\n]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function getDateStamp() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return (
      d.getFullYear() +
      pad(d.getMonth() + 1) +
      pad(d.getDate()) +
      "-" +
      pad(d.getHours()) +
      pad(d.getMinutes())
    );
  }

  function downloadFile(content, mimeType, filename) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ---- åœ–è¡¨ç›¸é—œ ----
  function safeHasData(obj) {
    return obj && Object.keys(obj).length > 0;
  }

  function computeDailyAndCategoryStats() {
    const data = loadAllData();
    const dailyScores = [];
    const categoryDoneCounts = {};
    const categoryHasAnyData = {};
    CATEGORY_CONFIG.forEach((cfg) => {
      categoryDoneCounts[cfg.key] = 0;
      categoryHasAnyData[cfg.key] = false;
    });

    let daysWithAnyData = 0;

    for (let day = 1; day <= TOTAL_DAYS; day++) {
      const dayKey = "day_" + day;
      const dayData = data[dayKey];
      const hasData = safeHasData(dayData || {});
      if (hasData) daysWithAnyData++;

      let completedThisDay = 0;
      CATEGORY_CONFIG.forEach((cfg) => {
        const done = isCategoryDoneFromDayData(dayData, cfg.key);
        if (done) {
          completedThisDay++;
          categoryDoneCounts[cfg.key] += 1;
        }
        if (hasData) {
          categoryHasAnyData[cfg.key] = true;
        }
      });
      dailyScores.push(completedThisDay);
    }

    const categoryRates = CATEGORY_CONFIG.map((cfg) => {
      const hasData = categoryHasAnyData[cfg.key];
      const denom = daysWithAnyData || TOTAL_DAYS;
      const rate = denom === 0 ? 0 : Math.round((categoryDoneCounts[cfg.key] / denom) * 100);
      return {
        key: cfg.key,
        label: cfg.label,
        count: categoryDoneCounts[cfg.key],
        rate,
        hasData,
      };
    });

    return {
      dailyScores,
      daysWithAnyData,
      categoryRates,
    };
  }

  function updateCharts() {
    if (!window.Chart || !dailyChartCanvas || !categoryChartCanvas) return;

    const { dailyScores, daysWithAnyData, categoryRates } = computeDailyAndCategoryStats();

    const labels = Array.from({ length: TOTAL_DAYS }, (_, i) => i + 1);

    // æ¯æ—¥å®Œæˆåº¦æŠ˜ç·šåœ–
    if (!dailyChart) {
      dailyChart = new Chart(dailyChartCanvas.getContext("2d"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "å®Œæˆé …ç›®æ•¸",
            data: dailyScores,
            borderColor: "#4455aa",
            backgroundColor: "rgba(68,85,170,0.10)",
            tension: 0.25,
            pointRadius: 0,
            borderWidth: 2,
            fill: true,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 8,
                color: "#8a8faf",
                callback: (value, index) => {
                  const d = labels[index];
                  return d === 1 || d % 10 === 0 ? "Day " + d : "";
                }
              },
              grid: {
                display: false
              }
            },
            y: {
              min: 0,
              max: 6,
              ticks: {
                stepSize: 1,
                color: "#8a8faf",
              },
              grid: {
                color: "rgba(170,178,220,0.25)",
                borderDash: [4, 4]
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex + 1;
                  return "Day " + idx;
                },
                label: (item) => `å®Œæˆ ${item.parsed.y} / 6 é …`
              }
            }
          }
        }
      });
    } else {
      dailyChart.data.labels = labels;
      dailyChart.data.datasets[0].data = dailyScores;
      dailyChart.update();
    }

    // æ¯æ—¥åœ–è¡¨ä¸‹æ–¹æ–‡å­—æ‘˜è¦
    if (dailyChartMeta) {
      const totalSum = dailyScores.reduce((sum, v) => sum + v, 0);
      const avg = (dailyScores.length > 0) ? (totalSum / dailyScores.length).toFixed(2) : "0.00";
      const recent30 = dailyScores.slice(-30);
      const recentAvg = recent30.length
        ? (recent30.reduce((a, b) => a + b, 0) / recent30.length).toFixed(2)
        : "-";

      dailyChartMeta.innerHTML = `
        <span>å·²å¡«å¯«å¤©æ•¸ï¼š<strong>${daysWithAnyData}</strong> / ${TOTAL_DAYS}</span>
        <span>å…¨æœŸæ—¥å‡å®Œæˆï¼š<strong>${avg}</strong> é … / 6</span>
        <span>æœ€è¿‘ 30 å¤©å¹³å‡ï¼š<strong>${recentAvg}</strong> é … / 6</span>
      `;
    }

    // å…­å¤§é …å®Œæˆç‡é•·æ¢åœ–
    const catLabels = categoryRates.map((c) => c.label);
    const catData = categoryRates.map((c) => c.rate);

    if (!categoryChart) {
      categoryChart = new Chart(categoryChartCanvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: catLabels,
          datasets: [{
            label: "å®Œæˆç‡%",
            data: catData,
            backgroundColor: "rgba(68,85,170,0.20)",
            borderColor: "#4455aa",
            borderWidth: 1.5,
            borderRadius: 8,
            maxBarThickness: 42,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: "#8a8faf"
              },
              grid: {
                display: false
              }
            },
            y: {
              min: 0,
              max: 100,
              ticks: {
                stepSize: 20,
                color: "#8a8faf",
                callback: (value) => value + "%"
              },
              grid: {
                color: "rgba(170,178,220,0.25)",
                borderDash: [4, 4]
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (item) => `${item.parsed.y}% å®Œæˆç‡`
              }
            }
          }
        }
      });
    } else {
      categoryChart.data.labels = catLabels;
      categoryChart.data.datasets[0].data = catData;
      categoryChart.update();
    }

    if (categoryChartMeta) {
      const best = [...categoryRates].sort((a, b) => b.rate - a.rate)[0];
      const worst = [...categoryRates].sort((a, b) => a.rate - b.rate)[0];

      categoryChartMeta.innerHTML = `
        <span>çµ±è¨ˆåŸºæº–å¤©æ•¸ï¼š<strong>${daysWithAnyData || 0}</strong> å¤©</span>
        <span>ç›®å‰æœ€ç©©å®šï¼š<strong>${best ? `${best.label}ï¼ˆ${best.rate}%ï¼‰` : "-"}</strong></span>
        <span>å¯ä»¥åŠ å¼·ï¼š<strong>${worst ? `${worst.label}ï¼ˆ${worst.rate}%ï¼‰` : "-"}</strong></span>
      `;
    }
  }

  // äº‹ä»¶ç¶å®šï¼šDay åˆ‡æ›
  daySelect.addEventListener("change", () => {
    setCurrentDay(getCurrentDay());
  });

  prevBtn.addEventListener("click", () => {
    setCurrentDay(getCurrentDay() - 1);
  });

  nextBtn.addEventListener("click", () => {
    setCurrentDay(getCurrentDay() + 1);
  });

  // æ‰€æœ‰æ¬„ä½æ”¹è®Šå°±è‡ªå‹•å„²å­˜
  fieldElements.forEach((el) => {
    el.addEventListener("change", saveCurrentDay);
    if (el.tagName === "TEXTAREA" || el.type === "text" || el.type === "number") {
      el.addEventListener("blur", saveCurrentDay);
    }
  });

  // åŒ¯å‡ºèˆ‡é‡ç½®
  exportJsonBtn.addEventListener("click", exportJSON);
  exportCsvBtn.addEventListener("click", exportCSV);
  resetDayBtn.addEventListener("click", resetCurrentDay);
  resetAllBtn.addEventListener("click", resetAllDays);

  // åº•éƒ¨å°è¦½åˆ‡æ›
  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      navButtons.forEach((b) => b.classList.toggle("active", b === btn));
      // æ›´æ–°ç•«é¢
      screens.forEach((screen) => {
        const screenName = screen.getAttribute("data-screen");
        screen.classList.toggle("active", screenName === target);
      });
      // æ²åˆ°æœ€ä¸Šæ–¹
      const mainEl = document.querySelector(".app-main");
      if (mainEl && mainEl.scrollTo) {
        mainEl.scrollTo({ top: 0, behavior: "auto" });
      } else if (mainEl) {
        mainEl.scrollTop = 0;
      }

      if (target === "charts") {
        // åˆ‡æ›åˆ°åœ–è¡¨é æ™‚æ›´æ–°ä¸€æ¬¡
        updateCharts();
      }
    });
  });

  // åˆå§‹åŒ–ç›®å‰å¤©æ•¸
  const lastDay = parseInt(localStorage.getItem(LAST_DAY_KEY) || "1", 10);
  setCurrentDay(lastDay >= 1 && lastDay <= TOTAL_DAYS ? lastDay : 1);
})();
</script>

<script>
  // PWA Service Worker è¨»å†Š
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker
        .register("service-worker.js")
        .catch(function (err) {
          console.log("ServiceWorker è¨»å†Šå¤±æ•—ï¼š", err);
        });
    });
  }
</script>
</body>
</html>
