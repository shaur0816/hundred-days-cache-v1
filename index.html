<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ç™¾æ—¥ç¯‰åŸºè¨ˆåŠƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="icon" type="image/png" href=".image/icon.png">
<link rel="apple-touch-icon" href=".image/icon.png">
<link rel="apple-touch-icon" sizes="180x180" href=".image/icon.png">
  <style>
    :root{
      /* æš–é™½æ©˜ä¸»é¡Œ */
      --bg:#FFF9E6;
      --card:#FFFFFF;
      --accent:#FFA85C;
      --accent-soft:#FFE1C2;
      --accent-strong:#E85C47;
      --text:#3b3b3b;
      --muted:#777;
      --green:#31A36C;
      --yellow-main:#FFD85A;
      --yellow-dark:#FFC938;
      --shadow:0 8px 20px rgba(0,0,0,.08);
      --radius-lg:18px;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
      background:radial-gradient(circle at top,#FFEBD2 0,var(--bg) 45%,#FFFFFF 100%);
      color:var(--text);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
    }
    .app{
      width:100%;
      max-width:520px;
      padding:16px 12px 32px;
      animation:fadeIn .6s ease-out;
    }
    @media(min-width:768px){
      .app{
        padding:24px 0 40px;
      }
    }

    /* header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .title-wrap{
      flex:1;
    }
    .title{
      font-size:26px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--accent-strong);
    }
    .subtitle{
      font-size:14px;
      color:var(--muted);
    }
    .day-nav{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }
    .day-display{
      font-size:18px;
      font-weight:600;
      padding:4px 10px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent-strong);
    }
    .day-buttons{
      display:flex;
      gap:4px;
    }
    .nav-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:16px;
      background:#ffffffaa;
      box-shadow:0 0 0 1px #FFD3A3;
      cursor:pointer;
      transition:transform .1s,box-shadow .1s,background .1s;
    }
    .nav-btn:active{
      transform:scale(.96);
      box-shadow:none;
      background:#FFE6C8;
    }

    /* summary */
    .summary-card{
      background:linear-gradient(135deg,#FFE1C2,#FFF1D7);
      border-radius:var(--radius-lg);
      padding:12px 14px;
      box-shadow:var(--shadow);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .summary-main{
      font-size:18px;
      font-weight:600;
      color:#C0522F;
    }
    .summary-sub{
      font-size:14px;
      color:#8a5a3a;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:13px;
      background:#ffffffdd;
      color:#C0522F;
      box-shadow:0 0 0 1px #FFD3A3;
    }

    .full-complete-note{
      text-align:center;
      font-size:15px;
      color:var(--green);
      font-weight:600;
      margin-bottom:12px;
      display:none;
    }

    /* category cards */
    .category-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:16px;
    }
    .category-card{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      cursor:pointer;
      border:2px solid transparent;
      transition:transform .12s,box-shadow .12s,border-color .12s,background .12s;
    }
    .category-card:active{
      transform:scale(.97);
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      background:#FFF7EA;
    }
    .category-card.done{
      border-color:var(--green);
    }
    .category-card.done::after{
      content:"å·²å®Œæˆ";
      position:absolute;
      right:10px;
      top:8px;
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--green);
      color:#fff;
    }
    .icon-wrap{
      width:54px;
      height:54px;
      border-radius:16px;
      background:var(--accent-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .icon{
      width:34px;
      height:34px;
      stroke:var(--accent-strong);
      fill:none;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .category-text{
      flex:1;
    }
    .category-title{
      font-size:18px;
      font-weight:600;
      margin-bottom:2px;
      color:#C0522F;
    }
    .category-desc{
      font-size:13px;
      color:var(--muted);
    }

    .status-dot{
      width:18px;
      height:18px;
      border-radius:999px;
      border:2px solid #ddd;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .status-dot-inner{
      width:10px;
      height:10px;
      border-radius:999px;
      background:#ddd;
      transition:background .15s,transform .15s;
    }
    .category-card.done .status-dot{
      border-color:var(--green);
    }
    .category-card.done .status-dot-inner{
      background:var(--green);
      transform:scale(1.1);
    }

    /* footer buttons */
    .footer-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:10px;
    }
    .primary-btn{
      border:none;
      border-radius:999px;
      padding:12px 18px;
      font-size:18px;
      font-weight:600;
      background:linear-gradient(135deg,var(--yellow-main),var(--yellow-dark));
      color:#5A4300;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:transform .12s,box-shadow .12s;
    }
    .primary-btn:active{
      transform:translateY(1px);
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .secondary-btn{
      border-radius:999px;
      padding:10px 16px;
      font-size:16px;
      border:none;
      background:#ffffffd8;
      box-shadow:var(--shadow);
      cursor:pointer;
      color:#844122;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* summary board */
    .day-summary-section{
      margin-top:12px;
      padding:12px 12px 16px;
      border-radius:var(--radius-lg);
      background:#FFF7EA;
      box-shadow:var(--shadow);
      border:1px solid #FFD3A3;
    }
    .day-summary-title{
      font-size:18px;
      font-weight:600;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:4px;
      color:#C0522F;
    }
    #daySummary{
      width:100%;
      min-height:200px;
      font-size:15px;
      border-radius:12px;
      border:2px solid #FFC27A;
      padding:8px;
      resize:vertical;
      font-family:inherit;
      line-height:1.5;
    }

    /* detail panel (tasks) */
    .panel{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.25);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s;
      z-index:20;
    }
    .panel.show{
      opacity:1;
      pointer-events:auto;
    }
    .panel-inner{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:20px 20px 0 0;
      padding:14px 16px 22px;
      box-shadow:0 -6px 20px rgba(0,0,0,.18);
      transform:translateY(100%);
      animation:slideUp .25s ease-out forwards;
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .panel-title{
      font-size:20px;
      font-weight:700;
      color:#C0522F;
    }
    .panel-close{
      border:none;
      background:none;
      font-size:26px;
      line-height:1;
      padding:4px 8px;
      cursor:pointer;
    }
    .tasks-list{
      list-style:none;
      margin:6px 0 14px;
      padding:0;
    }
    .tasks-list li{
      padding:8px 4px;
      border-bottom:1px dashed #eee;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .tasks-list input[type="checkbox"]{
      width:22px;
      height:22px;
      margin-top:2px;
      flex-shrink:0;
    }
    .tasks-list label{
      font-size:16px;
    }
    .tasks-list input[type="number"]{
      width:90px;
      font-size:16px;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #ddd;
      font-family:inherit;
    }
    .tasks-list .num-label{
      font-size:16px;
    }
    .tasks-list textarea{
      flex:1;
      font-size:15px;
      border-radius:10px;
      border:1px solid #ddd;
      padding:6px;
      min-height:60px;
      resize:vertical;
      font-family:inherit;
    }
    .panel-save-btn{
      width:100%;
      margin-top:4px;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:#333;
      color:#fff;
      font-size:14px;
      padding:8px 14px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s,transform .2s;
      z-index:40;
    }
    .toast.show{
      opacity:1;
      transform:translate(-50%,-4px);
    }

    /* æ»¾å‹•æ¢ï¼ˆChromeï¼‰å°æ©˜è‰² */
    textarea::-webkit-scrollbar{
      width:8px;
    }
    textarea::-webkit-scrollbar-thumb{
      background:#FFC27A;
      border-radius:4px;
    }
    textarea::-webkit-scrollbar-track{
      background:#FFF3DF;
    }

    /* animations */
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(6px);}
      to{opacity:1; transform:translateY(0);}
    }
    @keyframes slideUp{
      from{transform:translateY(100%);}
      to{transform:translateY(0);}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="header">
      <div class="title-wrap">
        <div class="title">
          <span>ğŸŒ¸ ç™¾æ—¥ç¯‰åŸºè¨ˆåŠƒ</span>
        </div>
        <div class="subtitle">èº«ãƒ»èªãƒ»æ„ å…­å‘ç·´ç¿’ï¼Œ100 å¤©ä¸€èµ·æ‰“å¡</div>
      </div>
      <div class="day-nav">
        <div class="day-display">
          Day <span id="dayNumber">1</span> / 100
        </div>
        <div class="day-buttons">
          <button class="nav-btn" id="prevDayBtn">â†</button>
          <button class="nav-btn" id="nextDayBtn">â†’</button>
        </div>
      </div>
    </header>

    <section class="summary-card" aria-label="ä»Šæ—¥ç¸½çµ">
      <div>
        <div class="summary-main">
          ä»Šæ—¥å®Œæˆé€²åº¦ï¼š<span id="todayDone">0</span> / 6
        </div>
        <div class="summary-sub">
          ä¸€é»ä¸€æ»´ç´¯ç©ï¼Œè®“å¿ƒæ›´å®‰ä½ã€‚
        </div>
      </div>
      <div class="chip">
        ğŸ”¥ å·²é€£çºŒ <span id="streakDays">0</span> å¤©
      </div>
    </section>

    <div class="full-complete-note" id="fullCompleteNote">
      âœ… ä»Šæ—¥å…¨éƒ¨å®Œæˆï¼Œè¾›è‹¦äº†ï¼
    </div>

    <main>
      <section class="category-list" id="categoryList">
        <!-- cards injected by JS -->
      </section>

      <section class="footer-actions">
        <button class="secondary-btn" id="resetDayBtn">
          ğŸ” æ¸…é™¤æœ¬æ—¥ç´€éŒ„ï¼ˆé‡ä¾†ï¼‰
        </button>
        <p class="hint">
          è³‡æ–™æœƒå­˜åˆ°ä½ çš„è£ç½®ï¼ˆLocalStorageï¼‰ï¼Œé—œæ‰ç¶²é ä¹Ÿæœƒä¿ç•™ã€‚
        </p>
      </section>

      <section class="day-summary-section">
        <div class="day-summary-title">
          ğŸ“ ä»Šæ—¥æ‘˜è¦
        </div>
        <textarea id="daySummary" placeholder="é€™è£¡æœƒè‡ªå‹•æ•´ç†ä»Šå¤©å…­é …çš„å®Œæˆæƒ…æ³ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œä¿®æ”¹è£œå……ã€‚"></textarea>
      </section>
    </main>
  </div>

  <!-- è©³ç´°ä»»å‹™é¢æ¿ -->
  <div class="panel" id="detailPanel" aria-hidden="true">
    <div class="panel-inner">
      <div class="panel-header">
        <div class="panel-title">
          <span id="detailTitle">å‡ºé›¢å¿ƒ</span>ãƒ»ä»Šæ—¥ç·´ç¿’
        </div>
        <button class="panel-close" id="closePanelBtn" aria-label="é—œé–‰">Ã—</button>
      </div>
      <ul class="tasks-list" id="tasksList">
        <!-- tasks injected -->
      </ul>
      <button class="primary-btn panel-save-btn" id="saveTasksBtn">
        ğŸ’¾ å„²å­˜é€™ä¸€é …
      </button>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" id="toast">å·²å„²å­˜</div>
  <script>
    // ===== è³‡æ–™è¨­å®š =====
    const STORAGE_KEY = 'hundredBasePlan_v3';

    // å…­å¤§é …è¨­å®šï¼šå‹¾é¸ä»»å‹™ã€æ•¸å­—ä»»å‹™ã€è‡ªå¡«æ¬„ä½
    const CATEGORIES = [
      {
        key: 'leaving',
        name: 'å‡ºé›¢å¿ƒ',
        desc: 'æ¯æ—¥æ€ç¶­ç„¡å¸¸ã€çš†è‹¦ã€‚',
        icon: 'lotus',
        checkboxTasks: [
          'æ¯æ—¥æ€ç¶­ã€Œç„¡å¸¸ã€å…­æ¬¡',
          'æ¯æ—¥æ€ç¶­ã€Œä¸€åˆ‡çš†è‹¦ã€å…­æ¬¡'
        ],
        numberTasks: [],
        textLabel: 'è‡ªè¡Œå¡«å¯«ï¼šä»Šå¤©å°ã€Œå‡ºé›¢å¿ƒã€æœ‰ä»€éº¼é«”æœƒæˆ–ç´€éŒ„ï¼Ÿ'
      },
      {
        key: 'bodhi',
        name: 'è©æå¿ƒ',
        desc: 'è¨˜å¾—çœ¾ç”Ÿä»åœ¨è¼ªè¿´ã€‚',
        icon: 'heart',
        checkboxTasks: [
          'æ¯æ—¥æ€ç¶­ã€Œå…­é“çˆ¶æ¯ä»åœ¨è¼ªè¿´ã€å…­æ¬¡',
          'æ¯æ—¥æ€ç¶­ã€Œç­‰å¾…æ•‘æ´çš„çœ¾ç”Ÿä»åœ¨è¼ªè¿´ã€å…­æ¬¡'
        ],
        numberTasks: [],
        textLabel: 'è‡ªè¡Œå¡«å¯«ï¼šä»Šå¤©ç‚ºçœ¾ç”Ÿç™¼äº†ä»€éº¼é¡˜ï¼Ÿ'
      },
      {
        key: 'body',
        name: 'èº«',
        desc: 'é‹å‹•ãƒ»é£²é£Ÿãƒ»ä½œæ¯ãƒ»æ›¬å¤ªé™½ã€‚',
        icon: 'body',
        checkboxTasks: [
          'é‹å‹•',
          'é£²é£Ÿ',
          'ä½œæ¯',
          'æ›¬å¤ªé™½ 10ï½15 åˆ†é˜'
        ],
        numberTasks: [],
        textLabel: 'è‡ªè¡Œå¡«å¯«ï¼šä»Šå¤©èº«é«”ç…§é¡§å¾—å¦‚ä½•ï¼Ÿ'
      },
      {
        key: 'speech',
        name: 'èª',
        desc: 'æ·¨åŒ–èªè¨€èˆ‡å‘¼å¸è¦ºçŸ¥ã€‚',
        icon: 'speech',
        checkboxTasks: [],
        numberTasks: [
          { field: 'purifyTimes', label: 'åŠ å¼·äº”å¤§æ·¨åŒ–æ³•', unit: 'æ¬¡' },
          { field: 'anapanaMinutes', label: 'åŠ å¼·å®‰é‚£èˆ¬é‚£', unit: 'åˆ†é˜' }
        ],
        textLabel: 'è‡ªè¡Œå¡«å¯«ï¼šä»Šå¤©åœ¨ã€Œèªã€ä¸Šæœ‰ä»€éº¼è§€å¯Ÿæˆ–ç·´ç¿’ï¼Ÿ'
      },
      {
        key: 'mind',
        name: 'æ„',
        desc: 'å®šèˆ‡æ…§çš„ç´¯ç©ã€‚',
        icon: 'mind',
        checkboxTasks: [],
        numberTasks: [
          { field: 'sitHours', label: 'å®šï¼šä»Šæ—¥å…±ä¸Šåº§', unit: 'å°æ™‚' },
          { field: 'sitTimes', label: 'å®šï¼šä»Šæ—¥å…±ä¸Šåº§', unit: 'æ¬¡' }
        ],
        textLabel: 'æ…§ï¼šè¤‡ç¿’çŸ¥è¦‹æˆ–æ˜¯æœ‰æ–°ç™¼ç¾ï¼Ÿè«‹å¯«ä¸‹ä¾†ã€‚'
      },
      {
        key: 'offseat',
        name: 'ä¸‹åº§',
        desc: 'ç”Ÿæ´»ä¸­ä¿æŒæ­£å¿µã€‚',
        icon: 'seat',
        checkboxTasks: [
          'æ¯æ—¥ç”¨æ‰‹æ©Ÿæ‰“ç™¼çš„æ™‚é–“ä½æ–¼ 1 å°æ™‚',
          'å°ˆå¿ƒå·¥ä½œ'
        ],
        numberTasks: [],
        textLabel: 'è‡ªè¡Œå¡«å¯«ï¼šä»Šå¤©ä¸‹åº§æ™‚ï¼Œå¦‚ä½•æŠŠä¿®è¡Œå¸¶å…¥ç”Ÿæ´»ï¼Ÿ'
      }
    ];

    // ===== ç‹€æ…‹è™•ç† =====
    let state = loadState();
    let currentDay = 1;
    let currentCategoryKey = null;

    const dayNumberEl = document.getElementById('dayNumber');
    const todayDoneEl = document.getElementById('todayDone');
    const streakDaysEl = document.getElementById('streakDays');
    const fullCompleteNoteEl = document.getElementById('fullCompleteNote');
    const categoryListEl = document.getElementById('categoryList');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const resetDayBtn = document.getElementById('resetDayBtn');

    const detailPanel = document.getElementById('detailPanel');
    const detailTitleEl = document.getElementById('detailTitle');
    const tasksListEl = document.getElementById('tasksList');
    const closePanelBtn = document.getElementById('closePanelBtn');
    const saveTasksBtn = document.getElementById('saveTasksBtn');

    const toastEl = document.getElementById('toast');
    const daySummaryEl = document.getElementById('daySummary');

    function defaultTaskState(cat){
      return {
        checkboxes: new Array(cat.checkboxTasks.length).fill(false),
        numbers: cat.numberTasks.reduce((obj, n)=>{
          obj[n.field] = '';
          return obj;
        },{}),
        text: ''
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && parsed.days){
            // ç¢ºä¿çµæ§‹å®Œæ•´
            CATEGORIES.forEach(cat=>{
              for(let d=1; d<=100; d++){
                if(!parsed.days[d]) parsed.days[d] = {tasks:{}, summary:'', userEditedSummary:false};
                if(!parsed.days[d].tasks) parsed.days[d].tasks = {};
                const t = parsed.days[d].tasks[cat.key];
                if(!t){
                  parsed.days[d].tasks[cat.key] = defaultTaskState(cat);
                }else if(Array.isArray(t)){
                  parsed.days[d].tasks[cat.key] = {
                    checkboxes: t,
                    numbers: cat.numberTasks.reduce((obj,n)=>{obj[n.field]='';return obj;},{}),
                    text:''
                  };
                }else{
                  if(!Array.isArray(t.checkboxes)){
                    t.checkboxes = new Array(cat.checkboxTasks.length).fill(false);
                  }else if(t.checkboxes.length < cat.checkboxTasks.length){
                    while(t.checkboxes.length < cat.checkboxTasks.length){
                      t.checkboxes.push(false);
                    }
                  }
                  if(!t.numbers) t.numbers = {};
                  cat.numberTasks.forEach(n=>{
                    if(typeof t.numbers[n.field] === 'undefined') t.numbers[n.field] = '';
                  });
                  if(typeof t.text !== 'string') t.text = '';
                }
              }
            });

            // ç‰ˆæœ¬å‡ç´šï¼šè£œ userEditedSummaryï¼Œä¸¦é‡æ–°ç”¢ç”Ÿæ‘˜è¦ä¸€æ¬¡ï¼ˆåªè¦ä½¿ç”¨è€…æ²’ç·¨è¼¯éï¼‰
            if(!parsed.version || parsed.version < 3){
              for(let d=1; d<=100; d++){
                if(typeof parsed.days[d].userEditedSummary === 'undefined'){
                  parsed.days[d].userEditedSummary = false;
                }
                if(!parsed.days[d].userEditedSummary){
                  parsed.days[d].summary = generateSummaryForDayFromState(parsed, d);
                }
              }
              parsed.version = 3;
              localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
            }

            return parsed;
          }
        }
      }catch(e){}
      // init new state
      const days = {};
      for(let d=1; d<=100; d++){
        days[d] = { tasks:{}, summary:'', userEditedSummary:false };
        CATEGORIES.forEach(cat=>{
          days[d].tasks[cat.key] = defaultTaskState(cat);
        });
      }
      return { days, version:3 };
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getDayCatState(day, catKey){
      const dayData = state.days[day];
      if(!dayData.tasks[catKey]){
        const cat = CATEGORIES.find(c=>c.key===catKey);
        dayData.tasks[catKey] = defaultTaskState(cat);
      }
      return dayData.tasks[catKey];
    }

    function setCurrentDay(day){
      if(day<1) day = 1;
      if(day>100) day = 100;
      currentDay = day;
      dayNumberEl.textContent = day;
      renderCategories();
      renderSummary();
      regenerateSummaryForDay(day); // ä¿è­‰é¡¯ç¤ºæœ€æ–°ç‹€æ…‹ï¼ˆè‹¥æ²’æ‰‹å‹•æ”¹éï¼‰
      renderDaySummary();
    }

    function isCategoryDone(day, key){
      const cat = CATEGORIES.find(c=>c.key===key);
      const t = getDayCatState(day, key);
      if(cat.checkboxTasks.length){
        if(!t.checkboxes || t.checkboxes.length < cat.checkboxTasks.length) return false;
        if(!t.checkboxes.every(v=>v)) return false;
      }
      if(cat.numberTasks.length){
        for(const n of cat.numberTasks){
          const v = (t.numbers && t.numbers[n.field]) || '';
          if(String(v).trim()==='') return false;
        }
      }
      if(!t.text || t.text.trim()==='') return false;
      return true;
    }

    function getDayDoneCount(day){
      let count = 0;
      CATEGORIES.forEach(cat=>{
        if(isCategoryDone(day, cat.key)) count++;
      });
      return count;
    }

    function computeStreak(){
      let streak = 0;
      for(let d=1; d<=100; d++){
        if(getDayDoneCount(d) === CATEGORIES.length){
          streak++;
        }else{
          break;
        }
      }
      return streak;
    }

    // ===== UI Rendering =====
    function createIconSVG(type){
      switch(type){
        case 'lotus':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <path d="M32 46 C20 44 14 36 12 28 C16 30 20 32 23 32 C22 26 24 20 28 16 C30 20 31.5 24 32 28 C32.5 24 34 20 36 16 C40 20 42 26 41 32 C44 32 48 30 52 28 C50 36 44 44 32 46 Z" />
          </svg>`;
        case 'heart':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <path d="M32 48 L18 34 C14 30 12 24 14 19 C16 15 20 13 24 13 C28 13 31 15 32 17 C33 15 36 13 40 13 C44 13 48 15 50 19 C52 24 50 30 46 34 Z" />
          </svg>`;
        case 'body':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <circle cx="32" cy="16" r="6" />
            <path d="M26 28 L24 40 L20 50 M38 28 L40 40 L44 50 M26 30 C29 28 35 28 38 30 M28 50 L28 40 L36 40 L36 50" />
          </svg>`;
        case 'speech':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <path d="M14 20 H50 V38 H30 L22 46 V38 H14 Z" />
            <circle cx="24" cy="28" r="2" />
            <circle cx="32" cy="28" r="2" />
            <circle cx="40" cy="28" r="2" />
          </svg>`;
        case 'mind':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <path d="M24 46 V38 H20 C16 34 16 26 20 22 C24 18 32 18 36 18 C42 18 48 22 48 30 C48 36 44 40 40 42 V46 Z" />
            <circle cx="32" cy="28" r="3" />
          </svg>`;
        case 'seat':
          return `
          <svg class="icon" viewBox="0 0 64 64">
            <rect x="18" y="26" width="28" height="10" rx="3" />
            <rect x="20" y="18" width="8" height="8" rx="2" />
            <rect x="36" y="18" width="8" height="8" rx="2" />
            <path d="M22 36 V46 M42 36 V46" />
          </svg>`;
        default:
          return '';
      }
    }

    function renderCategories(){
      categoryListEl.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const card = document.createElement('button');
        card.className = 'category-card';
        card.type = 'button';
        card.dataset.key = cat.key;

        if(isCategoryDone(currentDay, cat.key)){
          card.classList.add('done');
        }

        card.innerHTML = `
          <div class="icon-wrap">
            ${createIconSVG(cat.icon)}
          </div>
          <div class="category-text">
            <div class="category-title">${cat.name}</div>
            <div class="category-desc">${cat.desc}</div>
          </div>
          <div class="status-dot">
            <div class="status-dot-inner"></div>
          </div>
        `;

        card.addEventListener('click', ()=>{
          openDetail(cat.key);
        });

        categoryListEl.appendChild(card);
      });
    }

    function renderSummary(){
      const done = getDayDoneCount(currentDay);
      todayDoneEl.textContent = done;
      const allDone = (done === CATEGORIES.length);
      fullCompleteNoteEl.style.display = allDone ? 'block' : 'none';
      streakDaysEl.textContent = computeStreak();
    }

    /* -------------------------------------------
   ğŸ”¸ è©³ç´°ä»»å‹™é¢æ¿ï¼šæ‰“é–‹ï¼ˆä¿®æ­£ innerHTML â†’ createElementï¼‰
-------------------------------------------- */
function openDetail(categoryKey){
  currentCategoryKey = categoryKey;
  const cat = CATEGORIES.find(c=>c.key===categoryKey);
  const t = state.days[currentDay].tasks[categoryKey];

  detailTitleEl.textContent = cat.name;
  tasksListEl.innerHTML = "";

  /* --------------------------
     âœ” checkbox ä»»å‹™ï¼ˆä¿®æ­£ç‰ˆï¼‰
  -------------------------- */
  cat.checkboxTasks.forEach((text, idx)=>{
    const li = document.createElement("li");
    const id = `cb-${categoryKey}-${idx}`;

    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = id;
    input.dataset.type = "cb";
    input.dataset.index = idx;
    input.checked = !!t.checkboxes[idx];

    const label = document.createElement("label");
    label.setAttribute("for", id);
    label.textContent = text;

    li.appendChild(input);
    li.appendChild(label);
    tasksListEl.appendChild(li);
  });

  /* --------------------------
     âœ” number ä»»å‹™ï¼ˆä¿®æ­£ç‰ˆï¼‰
  -------------------------- */
  cat.numberTasks.forEach(n=>{
    const li = document.createElement("li");
    const id = `num-${categoryKey}-${n.field}`;

    const spanLabel = document.createElement("span");
    spanLabel.className = "num-label";
    spanLabel.textContent = n.label;

    const input = document.createElement("input");
    input.type = "number";
    input.id = id;
    input.dataset.type = "num";
    input.dataset.field = n.field;
    input.value = t.numbers[n.field] || "";

    const spanUnit = document.createElement("span");
    spanUnit.textContent = n.unit;

    li.appendChild(spanLabel);
    li.appendChild(input);
    li.appendChild(spanUnit);
    tasksListEl.appendChild(li);
  });

      // è‡ªå¡«æ–‡å­—
      const liText = document.createElement('li');
      liText.innerHTML = `
        <span class="num-label">${cat.textLabel}</span>
      `;
      const textarea = document.createElement('textarea');
      textarea.dataset.type = 'text';
      textarea.value = t.text || '';
      liText.appendChild(textarea);
      tasksListEl.appendChild(liText);

      detailPanel.classList.add('show');
      detailPanel.setAttribute('aria-hidden','false');
    }

    function closeDetail(){
      detailPanel.classList.remove('show');
      detailPanel.setAttribute('aria-hidden','true');
    }

    function saveDetailTasks(){
      if(!currentCategoryKey) return;
      const cat = CATEGORIES.find(c=>c.key === currentCategoryKey);
      const dayData = state.days[currentDay];
      if(!cat || !dayData) return;

      const t = getDayCatState(currentDay, currentCategoryKey);
      const cbs = [];
      const nums = Object.assign({}, t.numbers);
      let text = t.text || '';

      const inputs = tasksListEl.querySelectorAll('input, textarea');
      inputs.forEach(el=>{
        const type = el.dataset.type;
        if(type === 'cb'){
          const idx = Number(el.dataset.index);
          cbs[idx] = el.checked;
        }else if(type === 'num'){
          const field = el.dataset.field;
          nums[field] = el.value;
        }else if(type === 'text'){
          text = el.value;
        }
      });

      dayData.tasks[currentCategoryKey] = {
        checkboxes: cbs.length ? cbs : t.checkboxes,
        numbers: nums,
        text
      };

      saveState();
      renderCategories();
      renderSummary();
      regenerateSummaryForDay(currentDay); // â­ æ¯æ¬¡å„²å­˜å¾Œéƒ½é‡æ–°ç”¢ç”Ÿæ‘˜è¦ï¼ˆè‹¥ä½¿ç”¨è€…æ²’è‡ªè¡Œæ”¹éï¼‰
      renderDaySummary();
      showToast(`å·²å„²å­˜ Day ${currentDay}ãƒ»${cat.name}`);
    }

    // ===== ä»Šæ—¥æ‘˜è¦ï¼šç”¢ç”Ÿ / æ›´æ–° =====
    function generateSummaryForDayFromState(st, day){
      const lines = [];
      const doneCount = (()=> {
        let c = 0;
        CATEGORIES.forEach(cat=>{
          const data = st.days[day];
          if(!data) return;
          const t = data.tasks[cat.key];
          if(!t) return;
          let ok = true;
          if(cat.checkboxTasks.length){
            if(!t.checkboxes || t.checkboxes.length < cat.checkboxTasks.length) ok=false;
            else if(!t.checkboxes.every(v=>v)) ok=false;
          }
          if(ok && cat.numberTasks.length){
            for(const n of cat.numberTasks){
              const v = (t.numbers && t.numbers[n.field]) || '';
              if(String(v).trim()===''){ ok=false; break; }
            }
          }
          if(ok && (!t.text || t.text.trim()==='')) ok=false;
          if(ok) c++;
        });
        return c;
      })();

      lines.push(`Day ${day} ç™¾æ—¥ç¯‰åŸºç´€éŒ„`);
      lines.push(`ä»Šæ—¥å®Œæˆé€²åº¦ï¼š${doneCount} / 6`);
      lines.push('');

      CATEGORIES.forEach(cat=>{
        const dayData = st.days[day];
        const t = dayData && dayData.tasks[cat.key];
        const part = [];

        if(t){
          // checkbox
          cat.checkboxTasks.forEach((txt, idx)=>{
            if(t.checkboxes && t.checkboxes[idx]) part.push(txt);
          });

          // numbers
          cat.numberTasks.forEach(n=>{
            const v = (t.numbers && t.numbers[n.field]) || '';
            if(String(v).trim() !== ''){
              if(cat.key === 'mind' && (n.field === 'sitHours' || n.field === 'sitTimes')){
                // mind çš„å…©å€‹æ•¸å­—åœ¨ä¸‹é¢ä¸€èµ·è¼¸å‡º
              }else{
                part.push(`${n.label} ${v}${n.unit}`);
              }
            }
          });

          if(cat.key === 'mind'){
            const hours = t.numbers && t.numbers['sitHours'];
            const times = t.numbers && t.numbers['sitTimes'];
            if(String(hours||'').trim() !== '' || String(times||'').trim() !== ''){
              part.push(`å®šï¼šä»Šæ—¥å…±ä¸Šåº§ ${hours||'0'} å°æ™‚ / ${times||'0'} æ¬¡`);
            }
          }

          if(t.text && t.text.trim()!==''){
            part.push(`å¿ƒå¾—ï¼š${t.text.trim()}`);
          }
        }

        if(part.length){
          lines.push(`ã€${cat.name}ã€‘`);
          part.forEach(p=>lines.push('ãƒ»'+p));
        }else{
          lines.push(`ã€${cat.name}ã€‘å°šæœªè¨˜éŒ„ã€‚`);
        }
        lines.push('');
      });

      return lines.join('\n');
    }

    function generateSummaryForDay(day){
      return generateSummaryForDayFromState(state, day);
    }

    // åªè¦ä½¿ç”¨è€…æ²’æœ‰æ‰‹å‹•æ”¹éï¼Œå°±è‡ªå‹•é‡æ–°ç”¢ç”Ÿæ‘˜è¦
    function regenerateSummaryForDay(day){
      const dayData = state.days[day];
      if(dayData.userEditedSummary) return; // ä½¿ç”¨è€…æ‰‹å‹•ä¿®æ”¹éå°±å°Šé‡ä»–
      dayData.summary = generateSummaryForDay(day);
      saveState();
    }

    function renderDaySummary(){
      const dayData = state.days[currentDay];
      if(!dayData.userEditedSummary && (!dayData.summary || dayData.summary.trim()==='')){
        regenerateSummaryForDay(currentDay);
      }
      daySummaryEl.value = dayData.summary || '';
    }

    // ===== å…¶ä»–æ“ä½œ =====
    function showToast(text){
      toastEl.textContent = text;
      toastEl.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{
        toastEl.classList.remove('show');
      }, 1500);
    }

    // ===== äº‹ä»¶ç¶å®š =====
    prevDayBtn.addEventListener('click', ()=>{
      setCurrentDay(currentDay-1);
    });
    nextDayBtn.addEventListener('click', ()=>{
      setCurrentDay(currentDay+1);
    });

    resetDayBtn.addEventListener('click', ()=>{
      if(!confirm(`ç¢ºå®šè¦æ¸…é™¤ Day ${currentDay} çš„æ‰€æœ‰ç´€éŒ„ï¼ˆå«æ‘˜è¦ï¼‰å—ï¼Ÿ`)) return;
      const dayData = state.days[currentDay];
      CATEGORIES.forEach(cat=>{
        dayData.tasks[cat.key] = defaultTaskState(cat);
      });
      dayData.summary = '';
      dayData.userEditedSummary = false;
      regenerateSummaryForDay(currentDay);
      saveState();
      renderCategories();
      renderSummary();
      renderDaySummary();
      showToast(`å·²æ¸…é™¤ Day ${currentDay} çš„ç´€éŒ„`);
    });

    closePanelBtn.addEventListener('click', closeDetail);
    detailPanel.addEventListener('click', (e)=>{
      if(e.target === detailPanel) closeDetail();
    });
    saveTasksBtn.addEventListener('click', ()=>{
      saveDetailTasks();
      closeDetail();
    });

    // ä½¿ç”¨è€…åœ¨æ‘˜è¦ä¸­è¼¸å…¥ â†’ æ¨™è¨˜ç‚ºã€Œå·²æ‰‹å‹•ä¿®æ”¹ã€ï¼Œä¹‹å¾Œä¸å†è‡ªå‹•è¦†è“‹
    daySummaryEl.addEventListener('input', ()=>{
      const dayData = state.days[currentDay];
      dayData.summary = daySummaryEl.value;
      dayData.userEditedSummary = true;
      saveState();
    });

    // ===== åˆå§‹åŒ– =====
    setCurrentDay(currentDay);
  </script>
</body>
</html>
